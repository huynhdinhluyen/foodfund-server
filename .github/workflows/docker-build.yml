name: Optimized Build and Deploy

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ================= DETECT CHANGES =================
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      auth: ${{ steps.changes.outputs.auth }}
      user: ${{ steps.changes.outputs.user }}
      campaign: ${{ steps.changes.outputs.campaign }}
      operation: ${{ steps.changes.outputs.operation }}
      gateway: ${{ steps.changes.outputs.gateway }}
      shared: ${{ steps.changes.outputs.shared }}
      any-service: ${{ steps.changes.outputs.auth == 'true' || steps.changes.outputs.user == 'true' || steps.changes.outputs.campaign == 'true' || steps.changes.outputs.gateway == 'true' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            auth:
              - 'apps/auth/**'
              - 'libs/**'
              - 'package*.json'
            user:
              - 'apps/user/**'
              - 'libs/**'
              - 'package*.json'
            campaign:
              - 'apps/campaign/**'
              - 'libs/**'
              - 'package*.json'
            operation:
              - 'apps/operation/**'
              - 'libs/**'
              - 'package*.json'
            gateway:
              - 'apps/graphql-gateway/**'
              - 'libs/**'
              - 'package*.json'
            shared:
              - 'libs/**'
              - 'package*.json'
              - '.github/workflows/**'

  # ================= TEST CHANGED SERVICES =================
  test:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.any-service == 'true'
    strategy:
      fail-fast: false
      matrix:
        service: [auth, user, campaign, operation, gateway]
        include:
          - service: auth
            build-script: "build:auth"
            prisma-generate: false
          - service: user
            build-script: "build:user"
            prisma-generate: true
            prisma-path: "apps/user"
          - service: campaign
            build-script: "build:campaign"
            prisma-generate: true
            prisma-path: "apps/campaign"
          - service: operation
            build-script: "build:operation"
            prisma-generate: true
            prisma-path: "apps/operation"
          - service: gateway
            build-script: "build:gateway"
            prisma-generate: false
    
    steps:
      - uses: actions/checkout@v4
        if: needs.detect-changes.outputs[matrix.service] == 'true'
      
      - uses: actions/setup-node@v4
        if: needs.detect-changes.outputs[matrix.service] == 'true'
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        if: needs.detect-changes.outputs[matrix.service] == 'true'
        run: npm ci

      - name: Generate Prisma Client for ${{ matrix.service }}
        if: needs.detect-changes.outputs[matrix.service] == 'true' && matrix.prisma-generate == true
        run: |
          cd ${{ matrix.prisma-path }}
          npx prisma generate
        env:
          USERS_DATABASE_URL: ${{ secrets.USERS_DATABASE_URL }}
          CAMPAIGN_DATABASE_URL: ${{ secrets.CAMPAIGN_DATABASE_URL }}
          OPERATIONS_DATABASE_URL: ${{ secrets.OPERATIONS_DATABASE_URL }}

      - name: Lint ${{ matrix.service }}
        if: needs.detect-changes.outputs[matrix.service] == 'true'
        run: npm run lint:check

      # - name: Test ${{ matrix.service }}
      #   if: needs.detect-changes.outputs[matrix.service] == 'true'
      #   run: npm run test

      - name: Build ${{ matrix.service }}
        if: needs.detect-changes.outputs[matrix.service] == 'true'
        run: npm run ${{ matrix.build-script }}

  # ================= DOCKER BUILD & PUSH =================
  docker:
    needs: [detect-changes, test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && needs.detect-changes.outputs.any-service == 'true'
    strategy:
      fail-fast: false
      matrix:
        service: [auth, user, campaign, operation, gateway]
        include:
          - service: auth
            dockerfile: apps/auth/Dockerfile
            image: foodfund-auth
          - service: user
            dockerfile: apps/user/Dockerfile
            image: foodfund-user
          - service: campaign
            dockerfile: apps/campaign/Dockerfile
            image: foodfund-campaign
          - service: operation
            dockerfile: apps/operation/Dockerfile
            image: foodfund-operation
          - service: gateway
            dockerfile: apps/graphql-gateway/Dockerfile
            image: foodfund-graphql-gateway

    steps:
      - uses: actions/checkout@v4
        if: needs.detect-changes.outputs[matrix.service] == 'true'

      - uses: docker/setup-buildx-action@v3
        if: needs.detect-changes.outputs[matrix.service] == 'true'
        with:
          driver: docker-container
          install: true

      - uses: docker/login-action@v3
        if: needs.detect-changes.outputs[matrix.service] == 'true'
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set image tags
        if: needs.detect-changes.outputs[matrix.service] == 'true'
        run: |
          if [ "${GITHUB_REF##*/}" = "main" ]; then
            echo "TAG=latest" >> $GITHUB_ENV
            echo "UNIQUE_TAG=latest" >> $GITHUB_ENV
          else
            echo "TAG=develop" >> $GITHUB_ENV
            echo "UNIQUE_TAG=develop-${GITHUB_SHA::8}" >> $GITHUB_ENV
          fi

      - name: Build & Push ${{ matrix.service }} Service
        if: needs.detect-changes.outputs[matrix.service] == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.image }}:${{ env.TAG }}
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.image }}:${{ env.UNIQUE_TAG }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          platforms: linux/amd64

  # ================= BUILD SUMMARY =================
  build-summary:
    needs: [detect-changes, docker]
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'push'
    steps:
      - name: Build Summary
        run: |
          echo "## üöÄ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Changed | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Auth | ${{ needs.detect-changes.outputs.auth }} | ${{ needs.detect-changes.outputs.auth == 'true' && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| User | ${{ needs.detect-changes.outputs.user }} | ${{ needs.detect-changes.outputs.user == 'true' && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Campaign | ${{ needs.detect-changes.outputs.campaign }} | ${{ needs.detect-changes.outputs.campaign == 'true' && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Operation | ${{ needs.detect-changes.outputs.operation }} | ${{ needs.detect-changes.outputs.operation == 'true' && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gateway | ${{ needs.detect-changes.outputs.gateway }} | ${{ needs.detect-changes.outputs.gateway == 'true' && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} |" >> $GITHUB_STEP_SUMMARY

  # ================= DEPLOY =================
  deploy:
    needs: [detect-changes, docker]
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Set job timeout to 30 minutes
    if: github.event_name == 'push' && needs.detect-changes.outputs.any-service == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Install doctl
        env:
          DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
        run: |
          if [ -z "$DIGITALOCEAN_ACCESS_TOKEN" ]; then
            echo "DIGITALOCEAN_ACCESS_TOKEN not set; skipping doctl install"
            exit 0
          fi
          curl -sL https://github.com/digitalocean/doctl/releases/download/v1.110.0/doctl-1.110.0-linux-amd64.tar.gz | tar -xzv
          sudo mv doctl /usr/local/bin/doctl

      - name: Authenticate doctl and fetch kubeconfig
        env:
          DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          DO_K8S_CLUSTER_NAME: ${{ secrets.DO_K8S_CLUSTER_NAME }}
        run: |
          if [ -z "$DIGITALOCEAN_ACCESS_TOKEN" ] || [ -z "$DO_K8S_CLUSTER_NAME" ]; then
            echo "DIGITALOCEAN_ACCESS_TOKEN or DO_K8S_CLUSTER_NAME not set; skipping k8s deploy"
            exit 0
          fi
          doctl auth init -t $DIGITALOCEAN_ACCESS_TOKEN
          doctl kubernetes cluster kubeconfig save $DO_K8S_CLUSTER_NAME

      - name: Ensure namespace exists
        run: |
          kubectl create namespace foodfund-k8s --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy or update services with Helm
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          set -e
          
          # Set image tag based on branch
          if [ "${GITHUB_REF##*/}" = "main" ]; then
            TAG="latest"
            UNIQUE_TAG="latest"
          else
            TAG="develop"
            UNIQUE_TAG="develop-${GITHUB_SHA::8}"
          fi
          
          echo "=================================================="
          echo "üöÄ Deploying FoodFund Microservices"
          echo "=================================================="
          echo "Tag: $TAG (unique: $UNIQUE_TAG)"
          echo ""
          
          # ============================================
          # PHASE 1: Deploy Subgraph Services in Background (Parallel)
          # ============================================
          echo "üì¶ Phase 1: Deploying subgraph services in parallel..."
          echo ""
          
          # Start all subgraph deployments in background for parallel execution
          DEPLOY_PIDS=()
          
          if [ "${{ needs.detect-changes.outputs.auth }}" = "true" ]; then
            echo "üöÄ Starting auth-service deployment..."
            (
              helm upgrade --install auth-service k8s/charts/auth-service \
                --namespace foodfund-k8s \
                --set image.tag=$UNIQUE_TAG \
                --set image.repository=${DOCKERHUB_USERNAME}/foodfund-auth \
                --wait \
                --timeout 6m \
                --atomic \
              && echo "‚úÖ auth-service deployed" \
              || echo "‚ùå auth-service deployment failed"
            ) &
            DEPLOY_PIDS+=($!)
          fi
          
          if [ "${{ needs.detect-changes.outputs.user }}" = "true" ]; then
            echo "üöÄ Starting user-service deployment..."
            (
              helm upgrade --install user-service k8s/charts/user-service \
                --namespace foodfund-k8s \
                --set image.tag=$UNIQUE_TAG \
                --set image.repository=${DOCKERHUB_USERNAME}/foodfund-user \
                --wait \
                --timeout 6m \
                --atomic \
              && echo "‚úÖ user-service deployed" \
              || echo "‚ùå user-service deployment failed"
            ) &
            DEPLOY_PIDS+=($!)
          fi
          
          if [ "${{ needs.detect-changes.outputs.campaign }}" = "true" ]; then
            echo "üöÄ Starting campaign-service deployment..."
            (
              helm upgrade --install campaign-service k8s/charts/campaign-service \
                --namespace foodfund-k8s \
                --set image.tag=$UNIQUE_TAG \
                --set image.repository=${DOCKERHUB_USERNAME}/foodfund-campaign \
                --wait \
                --timeout 6m \
                --atomic \
              && echo "‚úÖ campaign-service deployed" \
              || echo "‚ùå campaign-service deployment failed"
            ) &
            DEPLOY_PIDS+=($!)
          fi

          if [ "${{ needs.detect-changes.outputs.operation }}" = "true" ]; then
            echo "üöÄ Starting operation-service deployment..."
            (
              helm upgrade --install operation-service k8s/charts/operation-service \
                --namespace foodfund-k8s \
                --set image.tag=$UNIQUE_TAG \
                --set image.repository=${DOCKERHUB_USERNAME}/foodfund-operation \
                --wait \
                --timeout 6m \
                --atomic \
              && echo "‚úÖ operation-service deployed" \
              || echo "‚ùå operation-service deployment failed"
            ) &
            DEPLOY_PIDS+=($!)
          fi
          
          # Wait for all background deployments to complete
          if [ ${#DEPLOY_PIDS[@]} -gt 0 ]; then
            echo ""
            echo "‚è≥ Waiting for ${#DEPLOY_PIDS[@]} deployment(s) to complete..."
            FAILED=0
            for pid in "${DEPLOY_PIDS[@]}"; do
              if ! wait $pid; then
                FAILED=$((FAILED + 1))
              fi
            done
            
            if [ $FAILED -gt 0 ]; then
              echo "‚ùå $FAILED deployment(s) failed!"
              exit 1
            fi
            
            echo "‚úÖ All subgraph deployments completed successfully!"
          fi
          echo ""
          
          # ============================================
          # PHASE 2: Wait for ALL Subgraphs to be Ready
          # ============================================
          echo "‚è≥ Phase 2: Verifying all subgraph services are ready..."
          echo ""
          
          # Give services a moment to stabilize
          sleep 10
          
          # Quick check for all existing services
          ALL_READY=true
          
          if kubectl get deployment auth-service -n foodfund-k8s &>/dev/null; then
            if ! kubectl wait --for=condition=available deployment/auth-service -n foodfund-k8s --timeout=120s 2>/dev/null; then
              echo "‚ö†Ô∏è  auth-service not ready yet"
              ALL_READY=false
            fi
          fi
          
          if kubectl get deployment user-service -n foodfund-k8s &>/dev/null; then
            if ! kubectl wait --for=condition=available deployment/user-service -n foodfund-k8s --timeout=120s 2>/dev/null; then
              echo "‚ö†Ô∏è  user-service not ready yet"
              ALL_READY=false
            fi
          fi
          
          if kubectl get deployment campaign-service -n foodfund-k8s &>/dev/null; then
            if ! kubectl wait --for=condition=available deployment/campaign-service -n foodfund-k8s --timeout=120s 2>/dev/null; then
              echo "‚ö†Ô∏è  campaign-service not ready yet"
              ALL_READY=false
            fi
          fi
          
          if kubectl get deployment operation-service -n foodfund-k8s &>/dev/null; then
            if ! kubectl wait --for=condition=available deployment/operation-service -n foodfund-k8s --timeout=120s 2>/dev/null; then
              echo "‚ö†Ô∏è  operation-service not ready yet"
              ALL_READY=false
            fi
          fi
          
          if [ "$ALL_READY" = true ]; then
            echo "‚úÖ All subgraph services are ready!"
          else
            echo "‚ö†Ô∏è  Some services may still be starting, but continuing with gateway deployment..."
          fi
          echo ""
          
          # ============================================
          # PHASE 3: Deploy GraphQL Gateway Last
          # ============================================
          if [ "${{ needs.detect-changes.outputs.gateway }}" = "true" ]; then
            echo "üåê Phase 3: Deploying GraphQL Gateway..."
            echo ""
            helm upgrade --install graphql-gateway k8s/charts/graphql-gateway \
              --namespace foodfund-k8s \
              --set image.tag=$UNIQUE_TAG \
              --set image.repository=${DOCKERHUB_USERNAME}/foodfund-graphql-gateway \
              --wait \
              --timeout 6m \
              --atomic
            echo "‚úÖ graphql-gateway deployed"
            echo ""
          fi
          
          echo "=================================================="
          echo "‚úÖ Deployment completed successfully!"
          echo "=================================================="

      - name: Final status
        run: |
          kubectl get pods -n foodfund-k8s
          kubectl get deployments -n foodfund-k8s
          kubectl get services -n foodfund-k8s
