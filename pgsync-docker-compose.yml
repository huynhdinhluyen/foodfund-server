version: '3.8'

services:
  # PGSync for campaign_db
  pgsync-campaign:
    build:
      context: ./pgsync-campaign
      dockerfile: Dockerfile
    container_name: pgsync-campaign
    restart: unless-stopped
    environment:
      # PostgreSQL (Campaign DB)
      PG_HOST: ${POSTGRES_HOST}
      PG_PORT: ${POSTGRES_PORT:-25060}
      PG_USER: ${POSTGRES_USER}
      PG_PASSWORD: ${POSTGRES_PASSWORD}
      PG_DATABASE: campaign_db
      
      # OpenSearch
      OPENSEARCH_HOST: ${OPENSEARCH_HOST}
      OPENSEARCH_PORT: ${OPENSEARCH_PORT:-443}
      OPENSEARCH_SCHEME: ${OPENSEARCH_SCHEME:-https}
      OPENSEARCH_USER: ${OPENSEARCH_USER:-admin}
      OPENSEARCH_PASSWORD: ${OPENSEARCH_PASSWORD}
      ELASTICSEARCH_USE_SSL: "True"
      ELASTICSEARCH_VERIFY_CERTS: "False"
      
      # Redis
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT:-25061}
      REDIS_DB: 0
      REDIS_AUTH: ${REDIS_PASSWORD}
      
      # PGSync Config
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      CHECKPOINT_PATH: /tmp/pgsync
    networks:
      - pgsync-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # PGSync for user_db
  pgsync-user:
    build:
      context: ./pgsync-user
      dockerfile: Dockerfile
    container_name: pgsync-user
    restart: unless-stopped
    environment:
      # PostgreSQL (User DB)
      PG_HOST: ${POSTGRES_HOST}
      PG_PORT: ${POSTGRES_PORT:-25060}
      PG_USER: ${POSTGRES_USER}
      PG_PASSWORD: ${POSTGRES_PASSWORD}
      PG_DATABASE: users_db
      
      # OpenSearch
      OPENSEARCH_HOST: ${OPENSEARCH_HOST}
      OPENSEARCH_PORT: ${OPENSEARCH_PORT:-443}
      OPENSEARCH_SCHEME: ${OPENSEARCH_SCHEME:-https}
      OPENSEARCH_USER: ${OPENSEARCH_USER:-admin}
      OPENSEARCH_PASSWORD: ${OPENSEARCH_PASSWORD}
      ELASTICSEARCH_USE_SSL: "True"
      ELASTICSEARCH_VERIFY_CERTS: "False"
      
      # Redis
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT:-25061}
      REDIS_DB: 1
      REDIS_AUTH: ${REDIS_PASSWORD}
      
      # PGSync Config
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      CHECKPOINT_PATH: /tmp/pgsync
    networks:
      - pgsync-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  pgsync-network:
    driver: bridge
